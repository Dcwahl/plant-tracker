<!DOCTYPE html>
<html>
<head>
	<title>{{if .ID}}Edit{{else}}New{{end}} Species - Plant Tracker</title>
	<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
	<style>
		body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
		h1 { color: #2d5016; }
		h3 { color: #2d5016; margin-top: 20px; margin-bottom: 10px; }
		.nav { margin-bottom: 20px; }
		.nav a { margin-right: 15px; padding: 8px 15px; text-decoration: none; background: #f0f0f0; border-radius: 4px; }
		form { background: #f9f9f9; padding: 20px; border-radius: 5px; }
		.form-group { margin-bottom: 15px; }
		label { display: block; margin-bottom: 5px; font-weight: bold; }
		input[type="text"], input[type="number"], select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
		input[type="checkbox"] { width: auto; margin-right: 5px; }
		.checkbox-group { display: flex; align-items: center; }
		.btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; }
		.btn-primary { background: #4CAF50; color: white; }
		.btn-secondary { background: #999; color: white; margin-left: 10px; }
		.btn-add { background: #2196F3; color: white; font-size: 14px; padding: 8px 16px; }
		.btn-remove { background: #f44336; color: white; font-size: 12px; padding: 4px 8px; }
		.form-actions { margin-top: 20px; }

		/* Stratification section */
		.stratification-section { margin-top: 20px; padding: 15px; background: #fff; border-radius: 5px; border: 1px solid #ddd; }
		.stratification-steps { margin-bottom: 15px; }
		.stratification-step { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; align-items: end; margin-bottom: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px; }
		.stratification-step .form-group { margin-bottom: 0; }
		.stratification-step label { font-size: 12px; }

		/* Tom Select overrides */
		.ts-wrapper { width: 100% !important; }
		.ts-control .item ~ input { display: none !important; }
	</style>
</head>
<body>
	<div class="nav">
		<a href="/">Batches</a>
		<a href="/species">Species</a>
	</div>

	<h1>{{if .ID}}Edit{{else}}New{{end}} Species</h1>
	<form method="POST" action="{{if .ID}}/species/update{{else}}/species/create{{end}}" id="speciesForm">
		{{if .ID}}
		<input type="hidden" name="id" value="{{.ID}}">
		{{end}}

		<div class="form-group">
			<label for="name">Species Name *</label>
			<input type="text" id="name" name="name" value="{{.Name}}" required>
		</div>

		<div class="stratification-section">
			<h3>Stratification</h3>
			<div id="stratification-steps" class="stratification-steps">
				<!-- Steps will be added here dynamically -->
			</div>
			<button type="button" class="btn btn-add" onclick="addStratificationStep()">+ Add Step</button>
		</div>

		<div class="form-actions">
			<button type="submit" class="btn btn-primary">{{if .ID}}Update{{else}}Create{{end}} Species</button>
			<a href="/species" class="btn btn-secondary">Cancel</a>
		</div>
	</form>

	<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
	<script>
		let stepCounter = 0;
		let tomSelectInstances = [];

		function addStratificationStep(type = '', moist = false, days = '') {
			const container = document.getElementById('stratification-steps');
			const stepDiv = document.createElement('div');
			stepDiv.className = 'stratification-step';
			stepDiv.dataset.stepIndex = stepCounter;

			stepDiv.innerHTML = `
				<div class="form-group">
					<label>Type</label>
					<select name="step_type[]" class="step-type-select" required>
						<option value="">Select type...</option>
						<option value="Cold" ${type === 'Cold' ? 'selected' : ''}>Cold</option>
						<option value="Warm" ${type === 'Warm' ? 'selected' : ''}>Warm</option>
						<option value="Scarification" ${type === 'Scarification' ? 'selected' : ''}>Scarification</option>
					</select>
				</div>
				<div class="form-group">
					<div class="checkbox-group">
						<input type="checkbox" name="step_moist[]" value="${stepCounter}" ${moist ? 'checked' : ''}>
						<label style="margin-bottom: 0; font-weight: normal;">Moist?</label>
					</div>
				</div>
				<div class="form-group">
					<label>Days</label>
					<input type="number" name="step_days[]" min="1" value="${days}" required>
				</div>
				<div>
					<button type="button" class="btn btn-remove" onclick="removeStratificationStep(this)">Remove</button>
				</div>
			`;

			container.appendChild(stepDiv);

			// Initialize Tom Select on the new dropdown
			const select = stepDiv.querySelector('.step-type-select');
			const ts = new TomSelect(select, {
				create: false,
				maxItems: 1,
				maxOptions: 10,
				closeAfterSelect: true
			});
			tomSelectInstances.push(ts);

			stepCounter++;
		}

		function removeStratificationStep(button) {
			const stepDiv = button.closest('.stratification-step');
			const select = stepDiv.querySelector('.step-type-select');

			// Destroy Tom Select instance
			if (select && select.tomselect) {
				select.tomselect.destroy();
			}

			stepDiv.remove();
		}

		// Load existing steps on page load (for edit mode)
		document.addEventListener('DOMContentLoaded', function() {
			{{range .StratificationSteps}}
			addStratificationStep('{{.Type}}', {{.Moist}}, {{.Days}});
			{{end}}
		});
	</script>
</body>
</html>
